<!DOCTYPE html>
<html>
<head>

  <title>web.experiment</title>
  <meta charset ="utf-8">  
  <link rel="stylesheet" href="styles.css">
  <link rel="shortcut icon" href="/assets/logo.png"/>

</head>

<body>

    <div class = "shadowmask" id = "shadow" style="display: none;">
      <div class="order" id = "order"style="display: none;">  
        <h1>Всплывающее окно</h1>  
        <p>Это всплывающее окно.</p>  
        <button id="closebutton">Закрыть</button>  
      </div>
    </div>

    <div class = 'cartbody' id ='cartbody'>
  
      <div class='header'>
  
        <a href="index.html" class = home>
          <img class = 'logo' src="assets\logoforhead2.png" alt="" width="320" height="96">
        </a>
  
        <a href="cart.html" class = shopbutton>
          <img class = 'bin' src="assets\P example.png" alt="" width="64" height="64">
        </a>
  
        <a href="profile.html" class = profilebutton>
          <img class = 'profile' src="assets\profile.png" alt="" width="64" height="64">
        </a>
  
      </div>
  
      <div class="backimage">

        <img src="assets/bin.jpg" alt="" width="1000" height="720">

        <div class = "binitem">
          <img src="assets/ite.jpg" alt="" width="159" height="159" style="margin-top: 1px;">

          <div class="bintext">
            
            <div class = "binh1">dragonborn jacket</div>

            <div class = "binh2">15000 rub.</div>
          
          </div>

          <div class="binsize">SIZE: M</div>

          <button class="cancelbutton"> </button>

        </div>

        <div class = "binitem">
          <img src="assets/ite.jpg" alt="" width="159" height="159" style="margin-top: 1px;">

          <div class="bintext">
            
            <div class = "binh1">dragonborn jacket</div>

            <div class = "binh2">15000 rub.</div>
          
          </div>

          <div class="binsize">SIZE: M</div>

          <button class="cancelbutton"> </button>

        </div>

        <div class = "binitem">
          <img src="assets/ite.jpg" alt="" width="159" height="159" style="margin-top: 1px;">

          <div class="bintext">
            
            <div class = "binh1">dragonborn jacket</div>

            <div class = "binh2">15000 rub.</div>
          
          </div>

          <div class="binsize">SIZE: M</div>

          <button class="cancelbutton"> </button>

        </div>


        <div class= "navButtons"> 
          <button class = "previtem"> PREV ITEMS </button>
          <button class = "nextitem"> NEXT ITEMS </button>
        </div>


      </div>

      <button class = "buttonOrder" id = "orderon"> ORDER </button>

      

    </div>

  <script>
    document.getElementById("orderon").addEventListener("click", function() {  
    document.getElementById("order").style.display = "block"; 
    document.getElementById("shadow").style.display = "block";
    document.getElementById("cartbody").style.position = "fixed";
    });  


    document.getElementById("closebutton").addEventListener("click", function() {  
    document.getElementById("order").style.display = "none";
    document.getElementById("shadow").style.display = "none";   
    document.getElementById("cartbody").style.position = "absolute";
    });

    let currentPage = 0;
    const itemsPerPage = 3;
    let cartItems = [];

      //при загрузке корзины
    document.addEventListener('DOMContentLoaded', () => {
        loadCart();
        setupEventListeners();
    });
                              
    //загрузка корзины с сервера
    function loadCart() {
        fetch('/cart.json') //запрос
            .then(response => {
                if (!response.ok) throw new Error('Ошибка загрузки корзины');
                return response.json();
            })
            .then(data => {
                cartItems = data;
                renderCartItems();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить корзину');
            });
    }

    //отображение товаров
    function renderCartItems() {
        const startIdx = currentPage * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;
        const itemsToShow = cartItems.slice(startIdx, endIdx);

        document.querySelectorAll('.binitem').forEach(item => {
            item.style.display = 'none';
        });

        //заполнение блоков данными
        itemsToShow.forEach((item, idx) => {
            const binItem = document.querySelectorAll('.binitem')[idx];
            if (!binItem) return;

            binItem.style.display = 'flex';
            binItem.querySelector('.binh1').textContent = item.name;
            binItem.querySelector('.binh2').textContent = `${item.price} rub.`;
            binItem.querySelector('.binsize').textContent = `SIZE: ${item.size}`;

            
            const deleteBtn = binItem.querySelector('.cancelbutton');
            deleteBtn.onclick = () => removeItem(startIdx + idx);
        });

    }

    // удаление предмета
    function removeItem(index) {
        fetch('/api/remove-from-cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index })
        })
        .then(response => response.json())
        .then(() => loadCart())
        .catch(error => {
            console.error('Ошибка удаления:', error);
            alert('Не удалось удалить товар');
        });
    }

    // функции заказа
    function showOrderForm() {

        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            placeOrder();
        });

        
        document.getElementById('close-popup').addEventListener('click', () => {
            orderPopup.style.display = 'none';
        });
    }

    // отправка заказа в бэк
    function placeOrder() {
        const form = document.getElementById('orderForm');
        const formData = new FormData(form);

        const orderData = {
            name: formData.get('name'),
            email: formData.get('email'),
            address: formData.get('address'),
            items: cartItems,
            total: cartItems.reduce((sum, item) => sum + item.price, 0)
        };

        fetch('/api/place-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Заказ оформлен! Номер заказа: ' + data.order_id);
                fetch('/api/clear-cart', { method: 'POST' })
                    .then(() => {
                        document.getElementById('order').style.display = 'none';
                        loadCart();
                    });
            } else {
                alert('Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при оформлении заказа');
        });
    }

    // функционал кнопок заказать, следующие и предыдущие предметы
    function setupEventListeners() {
        
        document.querySelector('.nextitem').addEventListener('click', () => {
            currentPage++;
            renderCartItems();
        });

        document.querySelector('.previtem').addEventListener('click', () => {
            currentPage--;
            renderCartItems();
        });


        
        document.getElementById('orderon').addEventListener('click', showOrderForm);
    }
  </script>
</body>
</html>
